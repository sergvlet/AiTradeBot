<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</title>
</head>

<body th:replace="~{layout :: layout(~{::title}, ~{::section}, 'strategies')}">

<section th:fragment="section"
         class="container py-4 strategy-settings-page"
         th:with="
            chatId=${chatId},
            type=${type},
            strategy=${strategy},
            exchangeSettings=${exchangeSettings},
            connectionOk=${connectionOk},
            selectedExchange=${selectedExchange},
            selectedNetwork=${selectedNetwork},
            diagnostics=${diagnostics},
            availableExchanges=${availableExchanges}
         ">

    <style>
        .strategy-settings-page .card-theme {
            background:#15171a;
            border:1px solid #2a2d31;
            border-radius:16px;
        }
        .strategy-settings-page .nav-tabs {
            border-bottom:1px solid rgba(148,163,184,0.4);
        }
        .strategy-settings-page .nav-tabs .nav-link {
            padding:12px 20px;
            font-size:1rem;
            cursor:pointer;
            border:none;
            border-radius:0;
        }
        .strategy-settings-page .tab-pane {
            display:none;
            padding-top:20px;
        }
        .strategy-settings-page .tab-pane.active {
            display:block;
        }
        .strategy-settings-page .section-title {
            font-size:1.05rem;
            font-weight:600;
            margin:20px 0 8px;
        }
    </style>

    <h2 class="fw-bold mb-4">
        <i class="bi bi-gear-wide-connected"></i>
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Äî <span th:text="${type}">SMART_FUSION</span>
    </h2>

    <form method="post"
          th:action="@{|/strategies/${type}/unified-settings?chatId=${chatId}|}"
          class="card card-theme p-4">

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><span class="nav-link tab-btn active" data-tab="network">–°–µ—Ç—å</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="general">–û–±—â–∏–µ</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="risk">–†–∏—Å–∫</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="trade">–¢–æ—Ä–≥–æ–≤–ª—è</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="advanced">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ</span></li>
        </ul>

        <!-- ======================== TAB 1 ‚Äî NETWORK ======================== -->
        <div class="tab-pane active" id="network">

            <div class="section-title">–ë–∏—Ä–∂–∞ –∏ —Å–µ—Ç—å</div>
            <div class="row g-4">

                <!-- –ë–∏—Ä–∂–∞ -->
                <div class="col-md-4">
                    <label class="form-label">–ë–∏—Ä–∂–∞</label>
                    <select id="exchangeSelect" class="form-control" name="exchange">
                        <option th:each="ex : ${availableExchanges}"
                                th:value="${ex}"
                                th:text="${ex}"
                                th:selected="${ex == selectedExchange}">
                        </option>
                    </select>
                </div>

                <!-- –°–µ—Ç—å -->
                <div class="col-md-4">
                    <label class="form-label">–°–µ—Ç—å</label>
                    <select id="networkSelect" class="form-control" name="network">
                        <option value="MAINNET"
                                th:selected="${selectedNetwork == T(com.chicu.aitradebot.common.enums.NetworkType).MAINNET}">
                            MAINNET
                        </option>
                        <option value="TESTNET"
                                th:selected="${selectedNetwork == T(com.chicu.aitradebot.common.enums.NetworkType).TESTNET}">
                            TESTNET
                        </option>
                    </select>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="col-md-4 d-flex flex-column justify-content-end">
                    <div class="fw-bold mb-1"
                         th:class="${connectionOk} ? 'text-success' : 'text-danger'">
                        <span th:text="${connectionOk} ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'"></span>
                    </div>

                    <div>
                        <span class="badge bg-success"
                              th:if="${exchangeSettings != null &&
                                      exchangeSettings.apiKey != null &&
                                      exchangeSettings.apiKey.length() >= 10}">
                            –ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
                        </span>

                        <span class="badge bg-secondary"
                              th:if="${exchangeSettings == null ||
                                     exchangeSettings.apiKey == null ||
                                     exchangeSettings.apiKey.length() < 10}">
                            –ö–ª—é—á–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
                        </span>
                    </div>
                </div>
            </div>

            <div class="section-title mt-4">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>

            <div id="diagnostics-box">

                <div th:if="${selectedExchange != 'BINANCE'}" class="text-warning">
                    –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Binance.
                </div>

                <div th:if="${selectedExchange == 'BINANCE'}">

                    <div th:if="${diagnostics == null}" class="text-secondary">
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (–≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ).
                    </div>

                    <table th:if="${diagnostics != null}"
                           class="table table-dark table-bordered align-middle text-center mt-2"
                           style="max-width: 600px;">
                        <tbody>
                        <tr>
                            <td>–ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω</td>
                            <td th:text="${diagnostics.keyValid ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.keyValid} ? 'text-success' : 'text-danger'"></td>
                        </tr>
                        <tr>
                            <td>–°–µ–∫—Ä–µ—Ç –≤–∞–ª–∏–¥–µ–Ω</td>
                            <td th:text="${diagnostics.secretValid ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.secretValid} ? 'text-success' : 'text-danger'"></td>
                        </tr>
                        <tr>
                            <td>–ß—Ç–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</td>
                            <td th:text="${diagnostics.readingEnabled ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.readingEnabled} ? 'text-success' : 'text-danger'"></td>
                        </tr>
                        <tr>
                            <td>–†–∞–∑—Ä–µ—à–µ–Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—è</td>
                            <td th:text="${diagnostics.tradingEnabled ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.tradingEnabled} ? 'text-success' : 'text-danger'"></td>
                        </tr>
                        <tr>
                            <td>IP —Ä–∞–∑—Ä–µ—à—ë–Ω</td>
                            <td th:text="${diagnostics.ipAllowed ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.ipAllowed} ? 'text-success' : 'text-danger'"></td>
                        </tr>
                        <tr>
                            <td>–°–µ—Ç—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç</td>
                            <td th:text="${diagnostics.networkMismatch ? '‚úñ –ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Ç—å' : '‚úî OK'}"
                                th:classappend="${diagnostics.networkMismatch} ? 'text-danger' : 'text-success'"></td>
                        </tr>
                        </tbody>
                    </table>

                    <div th:if="${diagnostics != null and diagnostics.reasons != null}">
                        <div class="alert alert-warning mt-2" th:each="r : ${diagnostics.reasons}">
                            ‚ö† <span th:text="${r}"></span>
                        </div>
                    </div>

                </div>
            </div>

            <div class="section-title mt-4">API –∫–ª—é—á–∏</div>

            <div class="row g-4">
                <div class="col-md-4">
                    <label class="form-label">API Key</label>
                    <input type="text"
                           class="form-control"
                           name="apiKey"
                           th:value="${exchangeSettings != null ? exchangeSettings.apiKey : ''}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Secret Key</label>
                    <input type="text"
                           class="form-control"
                           name="apiSecret"
                           th:value="${exchangeSettings != null ? exchangeSettings.apiSecret : ''}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Passphrase</label>
                    <input type="text"
                           class="form-control"
                           name="passphrase"
                           th:value="${exchangeSettings != null ? exchangeSettings.passphrase : ''}">
                </div>
            </div>

        </div>

        <!-- ======================== TAB 2 ‚Äî GENERAL ======================== -->
        <div class="tab-pane" id="general">

            <div class="section-title">–ö–∞–ø–∏—Ç–∞–ª –∏ –∫–æ–º–∏—Å—Å–∏–∏</div>

            <div class="row g-4">
                <div class="col-md-4">
                    <label class="form-label d-flex align-items-center justify-content-between">
                        <span>–ö–∞–ø–∏—Ç–∞–ª (USDT)</span>
                        <span class="text-info small">
                            üí∞ –î–æ—Å—Ç—É–ø–Ω–æ: <b th:text="${#numbers.formatDecimal(usdtBalance, 1, 4)}"></b> USDT
                        </span>
                    </label>

                    <input type="number" step="0.01" min="0"
                           class="form-control"
                           name="capitalUsd"
                           th:value="${strategy.capitalUsd}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–ö–æ–º–∏—Å—Å–∏—è (%)</label>
                    <input type="number" step="0.001"
                           class="form-control"
                           name="commissionPct"
                           th:value="${strategy.commissionPct}">
                    <button type="button"
                            id="refreshFeeBtn"
                            class="btn btn-sm btn-outline-info mt-3">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é
                    </button>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check form-switch mb-1">
                        <input class="form-check-input"
                               type="checkbox"
                               name="reinvestProfit"
                               th:checked="${strategy.reinvestProfit}">
                        <label class="form-check-label ms-2">–†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å</label>
                    </div>
                </div>
            </div>

        </div>

        <!-- ======================== TAB 3 ‚Äî RISK ======================== -->
        <div class="tab-pane" id="risk">

            <div class="section-title">–†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="riskPerTradePct"
                           th:value="${strategy.riskPerTradePct}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –ø–æ—Ç–µ—Ä—å (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="dailyLossLimitPct"
                           th:value="${strategy.dailyLossLimitPct}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–ü–ª–µ—á–æ</label>
                    <input type="number" min="1"
                           class="form-control"
                           name="leverage"
                           th:value="${strategy.leverage}">
                </div>

            </div>

            <div class="section-title">TP / SL</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">Take Profit (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="takeProfitPct"
                           th:value="${strategy.takeProfitPct}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Stop Loss (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="stopLossPct"
                           th:value="${strategy.stopLossPct}">
                </div>

            </div>

        </div>

        <!-- ======================== TAB 4 ‚Äî TRADE ======================== -->
        <div class="tab-pane" id="trade">

            <div class="section-title">–í—ã–±–æ—Ä —Ç–æ—Ä–≥–æ–≤–æ–π –ø–∞—Ä—ã</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">–ü–∞—Ä–∞</label>
                    <input type="text"
                           class="form-control"
                           id="symbolInput"
                           name="symbol"
                           th:value="${strategy.symbol}"
                           placeholder="BTCUSDT">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–¢–∞–π–º—Ñ—Ä–µ–π–º</label>
                    <select class="form-select" id="timeframeSelect" name="timeframe">
                        <option th:each="tf : ${availableTimeframes}"
                                th:value="${tf}"
                                th:text="${tf}"
                                th:selected="${tf == strategy.timeframe}">
                        </option>
                    </select>
                    <div class="form-text text-secondary">
                        –ü—Ä–∏–º–µ—Ä—ã: 1s, 5s, 15s, 1m, 3m, 5m, 15m, 30m, 1h, 4h, 1d
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">–°–≤–µ—á–µ–π –≤ –∫—ç—à–µ</label>
                    <input type="number"
                           min="50"
                           max="5000"
                           step="50"
                           class="form-control"
                           name="cachedCandlesLimit"
                           th:value="${strategy.cachedCandlesLimit}">
                </div>
            </div>

            <hr class="my-4">

            <div class="section-title">–ü–æ–∏—Å–∫ –º–æ–Ω–µ—Ç</div>

            <input id="marketSearch"
                   class="form-control mb-3"
                   placeholder="–ü–æ–∏—Å–∫: BTC, ETH, XRP...">

            <div id="marketResults"
                 class="table-responsive"
                 style="max-height: 420px; overflow-y: auto; border:1px solid #222; border-radius:8px;">
                <div class="text-center text-secondary p-3">
                    –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å‚Ä¶
                </div>
            </div>

        </div>

        <!-- ======================== TAB 5 ‚Äî ADVANCED ======================== -->
        <div class="tab-pane" id="advanced">

            <div class="section-title">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>

            <div class="alert alert-secondary small">
                –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ML / RL / SmartFusion.
            </div>

        </div>

        <hr class="my-4">

        <div class="d-flex gap-3">
            <a href="/strategies" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>

            <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>

    </form>
    <!-- ======================== JS ======================== -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {

            // ----------------------------------------------------
            // –ì–õ–ê–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
            // ----------------------------------------------------
            const chatId = /*[[${chatId}]]*/ 0;
            const type   = /*[[${type}]]*/ "SMART_FUSION";

            const exSel = document.getElementById("exchangeSelect");
            const ntSel = document.getElementById("networkSelect");

            const commissionInput = document.querySelector("input[name='commissionPct']");
            const refreshBtn = document.getElementById("refreshFeeBtn");

            const marketSearch = document.getElementById("marketSearch");
            const marketResults = document.getElementById("marketResults");
            const symbolInput = document.getElementById("symbolInput");

            // ----------------------------------------------------
            // –õ–û–ê–î–ï–†
            // ----------------------------------------------------
            function showLoader(text = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶") {
                let loader = document.getElementById("loader-overlay");
                if (!loader) {
                    loader = document.createElement("div");
                    loader.id = "loader-overlay";
                    loader.style.cssText =
                        "position:fixed;left:0;top:0;width:100%;height:100%;" +
                        "background:rgba(0,0,0,0.45);backdrop-filter:blur(3px);" +
                        "display:flex;align-items:center;justify-content:center;" +
                        "z-index:9999;opacity:0;transition:opacity .25s;";

                    const box = document.createElement("div");
                    box.style.cssText =
                        "padding:20px 40px;background:rgba(20,20,20,0.85);" +
                        "border-radius:12px;color:#fff;font-size:22px;font-weight:600;";
                    box.innerText = text;
                    loader.appendChild(box);

                    document.body.appendChild(loader);
                    setTimeout(() => loader.style.opacity = "1", 10);
                } else {
                    loader.style.opacity = "1";
                }
            }

            function hideLoader() {
                const loader = document.getElementById("loader-overlay");
                if (!loader) return;
                loader.style.opacity = "0";
                setTimeout(() => loader.remove(), 250);
            }

            // ----------------------------------------------------
            // –°–ú–ï–ù–ê –ë–ò–†–ñ–ò / –°–ï–¢–ò
            // ----------------------------------------------------
            function reloadWithParams() {
                showLoader("–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶");

                const ex = exSel.value;
                const nt = ntSel.value;

                setTimeout(() => {
                    window.location.href =
                        `/strategies/${type}/unified-settings?chatId=${chatId}&exchange=${ex}&network=${nt}`;
                }, 200);
            }

            if (exSel) exSel.addEventListener("change", reloadWithParams);
            if (ntSel) ntSel.addEventListener("change", reloadWithParams);

            // ----------------------------------------------------
            // –í–ö–õ–ê–î–ö–ò ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            // ----------------------------------------------------
            const tabs  = document.querySelectorAll(".tab-btn");
            const panes = document.querySelectorAll(".tab-pane");

            const TAB_KEY = "strategy_settings_active_tab";

            function activateTab(tabId) {
                tabs.forEach(t => t.classList.remove("active"));
                panes.forEach(p => p.classList.remove("active"));

                const btn = document.querySelector(`.tab-btn[data-tab='${tabId}']`);
                const pane = document.getElementById(tabId);

                if (btn) btn.classList.add("active");
                if (pane) pane.classList.add("active");

                localStorage.setItem(TAB_KEY, tabId);
            }

            // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏
            const savedTab = localStorage.getItem(TAB_KEY);
            if (savedTab && document.getElementById(savedTab)) {
                activateTab(savedTab);
            }

            tabs.forEach(btn => {
                btn.addEventListener("click", () => activateTab(btn.dataset.tab));
            });

            // ----------------------------------------------------
            // –†–ï–ê–õ–¨–ù–ê–Ø –ö–û–ú–ò–°–°–ò–Ø (–∞–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∞)
            // ----------------------------------------------------
            async function loadRealFee() {
                try {
                    const exchange = exSel.value;
                    const network  = ntSel.value;

                    const url =
                        `/strategies/${type}/unified-settings/real-fee?chatId=${chatId}&exchange=${exchange}&network=${network}`;

                    const res  = await fetch(url);
                    const data = await res.json();

                    const feeField = document.querySelector("input[name='commissionPct']");
                    if (!feeField) return;

                    feeField.value = Number(data.fee).toFixed(3);

                    if (data.ok && window.showToast)
                        showToast(`–ö–æ–º–∏—Å—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (VIP${data.vipLevel}, BNB=${data.bnb})`, true);

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏:", e);
                }
            }

            if (commissionInput) loadRealFee();

            // ----------------------------------------------------
            // –ö–ù–û–ü–ö–ê –û–ë–ù–û–í–ò–¢–¨ –ö–û–ú–ò–°–°–ò–Æ
            // ----------------------------------------------------
            if (refreshBtn) {
                refreshBtn.addEventListener("click", async () => {

                    refreshBtn.disabled = true;
                    refreshBtn.innerText = "–û–±–Ω–æ–≤–ª—è–µ–º‚Ä¶";

                    try {
                        const ex = exSel.value;
                        const nt = ntSel.value;

                        const res = await fetch(
                            `/strategies/${type}/unified-settings/real-fee?chatId=${chatId}&exchange=${ex}&network=${nt}`
                        );

                        const data = await res.json();

                        const feeField = document.querySelector("input[name='commissionPct']");
                        if (feeField)
                            feeField.value = Number(data.fee).toFixed(3);

                        if (window.showToast)
                            showToast("–ö–æ–º–∏—Å—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞", true);

                    } catch (e) {
                        if (window.showToast)
                            showToast("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏", false);
                    }

                    refreshBtn.disabled = false;
                    refreshBtn.innerText = "üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é";
                });
            }

            // ----------------------------------------------------
            // –ü–û–ò–°–ö –ú–û–ù–ï–¢
            // ----------------------------------------------------
            let searchTimer = null;

            async function loadMarketSearch(query) {

                if (!marketResults) return;

                if (!query || query.trim().length < 1) {
                    marketResults.innerHTML = `
                        <div class="text-center text-secondary p-3">
                            –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å‚Ä¶
                        </div>`;
                    return;
                }

                const ex = exSel.value;
                const nt = ntSel.value;

                const url = `/api/market/search?exchange=${ex}&network=${nt}&q=${encodeURIComponent(query)}`;

                try {
                    marketResults.innerHTML = `
                        <div class="text-center text-info p-3">
                            –ü–æ–∏—Å–∫‚Ä¶
                        </div>`;

                    const res = await fetch(url);
                    const list = await res.json();

                    if (!Array.isArray(list) || list.length === 0) {
                        marketResults.innerHTML = `
                            <div class="text-center text-secondary p-3">
                                –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                            </div>`;
                        return;
                    }

                    let html = `
                        <table class="table table-dark table-sm table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>–ü–∞—Ä–∞</th>
                                    <th>–¶–µ–Ω–∞</th>
                                    <th>24h %</th>
                                    <th>–û–±—ä—ë–º</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>`;

                    list.forEach(s => {
                        const pct = Number(s.changePct || 0);
                        const pctColor = pct >= 0 ? "text-success" : "text-danger";

                        html += `
                            <tr>
                                <td>${s.symbol}</td>
                                <td>${Number(s.price).toFixed(6)}</td>
                                <td class="${pctColor}">${pct.toFixed(2)}%</td>
                                <td>${Number(s.volume).toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary select-symbol" data-symbol="${s.symbol}">
                                        –í—ã–±—Ä–∞—Ç—å
                                    </button>
                                </td>
                            </tr>`;
                    });

                    html += "</tbody></table>";
                    marketResults.innerHTML = html;

                    document.querySelectorAll(".select-symbol").forEach(btn => {
                        btn.addEventListener("click", () => {
                            if (symbolInput)
                                symbolInput.value = btn.dataset.symbol;

                            if (window.showToast)
                                showToast(`–í—ã–±—Ä–∞–Ω–∞ –ø–∞—Ä–∞: ${btn.dataset.symbol}`, true);
                        });
                    });

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", e);
                    marketResults.innerHTML =
                        `<div class="text-danger text-center p-3">
                            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                        </div>`;
                }
            }

            // debounce
            if (marketSearch) {
                marketSearch.addEventListener("input", () => {
                    const q = marketSearch.value.trim();
                    clearTimeout(searchTimer);
                    searchTimer = setTimeout(() => loadMarketSearch(q), 200);
                });
            }

        }); // END DOMContentLoaded
    </script>

</section>
</body>
</html>
