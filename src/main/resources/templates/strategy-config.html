<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body th:replace="~{layout :: layout(~{::title}, ~{::section}, 'strategies')}">

<section th:with="chatId=${chatId}" th:attr="data-chat-id=${chatId}">

    <style>
        #symbol-menu {
            position: fixed !important;
            display: none;
            max-height: 260px;
            overflow: auto;
            min-width: 240px;
            background: var(--bs-body-bg, #121212);
            border: 1px solid rgba(255,255,255,.15);
            border-radius: .375rem;
            box-shadow: 0 6px 18px rgba(0,0,0,.25);
            z-index: 9999 !important;
        }
        #symbol-menu .dropdown-item.active,
        #symbol-menu .dropdown-item:active {
            background-color: rgba(13,110,253,.15);
        }
    </style>

    <h2 class="fw-bold mb-4">
        <i class="bi bi-sliders"></i>
        <span th:text="${strategy.strategyName}">Smart Fusion</span> ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    </h2>

    <div class="card card-theme p-4">
        <form id="sf-form" class="row g-4" novalidate>
            <h5 class="mb-3"><i class="bi bi-graph-up"></i> –†—ã–Ω–æ–∫ –∏ —Å–≤–µ—á–∏</h5>

            <div class="row g-3">
                <!-- –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ -->
                <div class="col-md-4 position-relative">
                    <label class="form-label">–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞</label>
                    <input type="text" class="form-control" id="symbol-input"
                           name="symbol"
                           th:value="${settings.symbol}"
                           list="symbol-list"
                           placeholder="BTCUSDT" autocomplete="off">

                    <datalist id="symbol-list"></datalist>
                    <div id="symbol-menu" class="dropdown-menu show"></div>

                    <div id="symbol-loading" class="form-text text-muted" style="display:none;">
                        ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞—Ä...
                    </div>
                </div>

                <!-- –ë–∏—Ä–∂–∞ -->
                <div class="col-md-4">
                    <label class="form-label">–ë–∏—Ä–∂–∞</label>
                    <select class="form-select" name="exchange" id="exchange-select">
                        <option value="BINANCE" th:selected="${settings.exchange=='BINANCE'}">BINANCE</option>
                        <option value="BYBIT" th:selected="${settings.exchange=='BYBIT'}">BYBIT</option>
                        <option value="OKX" th:selected="${settings.exchange=='OKX'}">OKX</option>
                    </select>
                </div>

                <!-- –°–µ—Ç—å -->
                <div class="col-md-4">
                    <label class="form-label">–°–µ—Ç—å</label>
                    <select class="form-select" name="networkType" id="network-select">
                        <option value="TESTNET" th:selected="${settings.networkType?.name()=='TESTNET'}">TESTNET</option>
                        <option value="MAINNET" th:selected="${settings.networkType?.name()=='MAINNET'}">MAINNET</option>
                    </select>
                </div>

                <!-- –¢–∞–π–º—Ñ—Ä–µ–π–º -->
                <div class="col-md-4">
                    <label class="form-label">–¢–∞–π–º—Ñ—Ä–µ–π–º</label>
                    <select class="form-select" id="timeframe-select" name="timeframe">
                        <option disabled selected>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>

                <!-- –°–≤–µ—á–∏ -->
                <div class="col-md-4">
                    <label class="form-label">–°–≤–µ—á–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
                    <input type="number" class="form-control" name="candleLimit"
                           min="100" max="1000" step="50" th:value="${settings.candleLimit}">
                </div>
            </div>

            <hr class="my-3">

            <h5 class="mb-3"><i class="bi bi-shield-check"></i> –ö–∞–ø–∏—Ç–∞–ª –∏ —Ä–∏—Å–∫</h5>

            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">–ö–∞–ø–∏—Ç–∞–ª, USDT</label>
                    <input type="number" class="form-control" name="capitalUsd" th:value="${settings.capitalUsd}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">–ü–ª–µ—á–æ</label>
                    <input type="number" class="form-control" name="leverage" th:value="${settings.leverage}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É, %</label>
                    <input type="number" class="form-control" name="riskPerTradePct" th:value="${settings.riskPerTradePct}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –ø–æ—Ç–µ—Ä—å, %</label>
                    <input type="number" class="form-control" name="dailyLossLimitPct" th:value="${settings.dailyLossLimitPct}">
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="reinvest-profit"
                               name="reinvestProfit" th:checked="${settings.reinvestProfit}">
                        <label class="form-check-label" for="reinvest-profit">
                            –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å
                        </label>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <a href="/strategies" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
                <button id="sf-save" type="button" class="btn btn-theme">
                    <i class="bi bi-check2-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </form>
    </div>

    <!-- === –°–∫—Ä–∏–ø—Ç Smart Fusion === -->
    <script>
        (function(){
            console.log("üß© SmartFusion settings script –∑–∞–≥—Ä—É–∂–µ–Ω");
            document.addEventListener("DOMContentLoaded", () => {
                const symbolInput = document.getElementById("symbol-input");
                const exchangeSelect = document.getElementById("exchange-select");
                const networkSelect = document.getElementById("network-select");
                const datalist = document.getElementById("symbol-list");
                const loadingText = document.getElementById("symbol-loading");
                const symbolMenu = document.getElementById("symbol-menu");
                const timeframeSelect = document.getElementById("timeframe-select");

                if(!symbolInput || !exchangeSelect || !networkSelect) return;

                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –º–µ–Ω—é –≤ body
                requestAnimationFrame(()=>{ document.body.appendChild(symbolMenu); });

                let currentSymbols = [];
                const cache = {};

                async function loadSymbols(exchange, network){
                    const key = exchange+"_"+network;
                    if(cache[key]) return cache[key];
                    loadingText.style.display="block";
                    try{
                        const res = await fetch(`/api/exchange/symbols?exchange=${exchange}&networkType=${network}`);
                        const data = await res.json();
                        cache[key] = Array.isArray(data)?data:[];
                        return cache[key];
                    }catch(e){
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤", e);
                        if(window.showToast) showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—ã","danger");
                        return [];
                    }finally{ loadingText.style.display="none"; }
                }

                function renderMenu(list){
                    symbolMenu.innerHTML="";
                    list.forEach(s=>{
                        const b=document.createElement("button");
                        b.className="dropdown-item";
                        b.type="button"; b.textContent=s;
                        b.addEventListener("mousedown",e=>{
                            e.preventDefault();
                            symbolInput.value=s;
                            symbolMenu.style.display="none";
                        });
                        symbolMenu.appendChild(b);
                    });
                }

                async function showList(){
                    const ex=exchangeSelect.value, net=networkSelect.value;
                    const list=await loadSymbols(ex,net);
                    currentSymbols=list;
                    renderMenu(list);
                    const r=symbolInput.getBoundingClientRect();
                    symbolMenu.style.left=r.left+"px";
                    symbolMenu.style.top=r.bottom+window.scrollY+"px";
                    symbolMenu.style.width=r.width+"px";
                    symbolMenu.style.display="block";
                }

                symbolInput.addEventListener("focus",showList);
                symbolInput.addEventListener("input",()=>{
                    const q=symbolInput.value.toUpperCase();
                    renderMenu(currentSymbols.filter(s=>s.includes(q)));
                });
                document.addEventListener("click",e=>{
                    if(!symbolMenu.contains(e.target)&&e.target!==symbolInput)
                        symbolMenu.style.display="none";
                });

                // –¢–∞–π–º—Ñ—Ä–µ–π–º—ã
                async function updateTimeframes(){
                    timeframeSelect.innerHTML='<option disabled selected>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</option>';
                    try{
                        const ex=exchangeSelect.value, net=networkSelect.value;
                        const res=await fetch(`/api/exchange/timeframes?exchange=${ex}&networkType=${net}`);
                        const data=await res.json();
                        timeframeSelect.innerHTML="";
                        data.forEach(tf=>{
                            const o=document.createElement("option");
                            o.value=tf;o.textContent=tf;
                            timeframeSelect.appendChild(o);
                        });
                        if(data.length) timeframeSelect.value=data[0];
                    }catch(e){
                        console.error("–û—à–∏–±–∫–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤",e);
                        if(window.showToast) showToast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã","danger");
                    }
                }
                exchangeSelect.addEventListener("change",updateTimeframes);
                networkSelect.addEventListener("change",updateTimeframes);
                updateTimeframes();
            });
        })();
    </script>

</section>

</body>
</html>
