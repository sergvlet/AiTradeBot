<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body th:replace="~{layout :: layout(~{::title}, ~{::section}, 'strategies')}">

<section>
  <h2 class="fw-bold mb-4">
    <i class="bi bi-diagram-3"></i> –°—Ç—Ä–∞—Ç–µ–≥–∏–∏
  </h2>

  <div class="row g-4">

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
    <div class="col-md-4 col-sm-6" th:each="s : ${strategies}">

      <div class="card card-theme h-100 shadow-sm border-0"
           th:classappend="${s.active} ? ' border-success border-2' : ''">

        <div class="card-body text-center">

          <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
          <h5 class="card-title fw-semibold mb-2"
              th:text="${s.title}">Strategy</h5>

          <!-- –°—Ç–∞—Ç—É—Å -->
          <span class="badge px-3 py-2 mb-2"
                th:classappend="${s.active} ? ' bg-success' : ' bg-secondary'"
                th:text="${s.active} ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'">
            ‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
          </span>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
          <div class="small text-muted">
            <div>PnL: <span th:text="${s.totalProfitPct}">‚Äî</span>%</div>
            <div>ML –¥–æ–≤–µ—Ä–∏–µ: <span th:text="${s.mlConfidence}">‚Äî</span></div>
            <div>–°–µ—Ç—å: <span th:text="${s.networkType}">MAINNET</span></div>
            <div>–ü–∞—Ä–∞: <span th:text="${s.symbol}">BTCUSDT</span></div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ -->
          <div class="mt-4 d-grid gap-2">

            <!-- üöÄ –ó–∞–ø—É—Å–∫ / –û—Å—Ç–∞–Ω–æ–≤–∫–∞ -->
            <button type="button"
                    class="btn toggle-btn"
                    th:classappend="${s.active} ? ' btn-outline-danger' : ' btn-outline-success'"
                    th:data-type="${s.strategyType}"
                    th:data-chat-id="${s.chatId}"
                    th:data-symbol="${s.symbol}"
                    th:data-active="${s.active}">
              <i th:class="${s.active} ? 'bi bi-stop-fill' : 'bi bi-play-fill'"></i>
              <span th:text="${s.active} ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å'">–ó–∞–ø—É—Å—Ç–∏—Ç—å</span>
            </button>

            <!-- üìä –î–∞—à–±–æ—Ä–¥ -->
            <a class="btn btn-outline-primary"
               th:href="@{'/strategies/' + ${s.strategyType} + '/dashboard'(chatId=${s.chatId}, symbol=${s.symbol})}">
              <i class="bi bi-graph-up"></i> –î–∞—à–±–æ—Ä–¥
            </a>

            <!-- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <a th:href="@{'/strategies/' + ${s.strategyType} + '/unified-settings'(chatId=${s.chatId})}"
               class="btn btn-outline-primary">
              <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
            </a>


          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- ===========================
       JS TOGGLE
  ============================ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      document.querySelectorAll(".toggle-btn").forEach(btn => {

        btn.addEventListener("click", async (e) => {
          e.preventDefault();

          const chatId = btn.dataset.chatId;
          const type = btn.dataset.type;
          const symbol = btn.dataset.symbol;
          const active = btn.dataset.active === "true";

          const card = btn.closest(".card");
          const badge = card.querySelector(".badge");

          const icon = btn.querySelector("i");
          const label = btn.querySelector("span");

          btn.disabled = true;

          if (icon) {
            icon.className = active ? "bi bi-stop-fill" : "bi bi-play-fill";
          }
          if (label) {
            label.textContent = active ? " –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..." : " –ó–∞–ø—É—Å–∫–∞–µ–º...";
          }

          try {
            const res = await fetch(
                    `/api/strategy/toggle?chatId=${chatId}&type=${type}&symbol=${symbol}`,
                    {
                      method: "POST",
                      headers: { "Accept": "application/json" }
                    }
            );

            const text = await res.text();
            const data = JSON.parse(text || "{}");

            if (!res.ok || data.status === "error") {
              throw new Error(data.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏");
            }

            const started = data.status === "started";
            btn.dataset.active = String(started);

            btn.classList.toggle("btn-outline-success", !started);
            btn.classList.toggle("btn-outline-danger", started);

            if (icon) {
              icon.className = started ? "bi bi-stop-fill" : "bi bi-play-fill";
            }
            if (label) {
              label.textContent = started ? "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–ó–∞–ø—É—Å—Ç–∏—Ç—å";
            }

            if (badge) {
              badge.textContent = started ? "üü¢ –ê–∫—Ç–∏–≤–Ω–∞" : "‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
              badge.classList.toggle("bg-success", started);
              badge.classList.toggle("bg-secondary", !started);
            }

            if (window.showToast) {
              showToast(started ? "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–ø—É—â–µ–Ω–∞" : "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", started);
            }

            if (data.redirect) {
              window.location.href = data.redirect;
            }

          } catch (err) {
            console.error("–û—à–∏–±–∫–∞:", err);
            if (window.showToast) {
              showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏", false);
            }
          } finally {
            btn.disabled = false;
          }
        });

      });

    });
  </script>

</section>

</body>
</html>
