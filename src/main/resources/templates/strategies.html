<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body th:replace="~{layout :: layout(~{::title}, ~{::section}, 'strategies')}">

<section>
  <h2 class="fw-bold mb-4"><i class="bi bi-diagram-3"></i> –°—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>

  <div class="row g-4">
    <div class="col-md-4 col-sm-6" th:each="s : ${strategies}">
      <div class="card card-theme h-100 shadow-sm border-0"
           th:classappend="${s.active} ? 'border-success border-2' : ''">
        <div class="card-body text-center">

          <h5 class="card-title fw-semibold mb-2" th:text="${s.strategyName}">Strategy</h5>

          <span class="badge px-3 py-2 mb-2"
                th:classappend="${s.active} ? 'bg-success' : 'bg-secondary'"
                th:text="${s.active} ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'">–ê–∫—Ç–∏–≤–Ω–∞</span>

          <div class="small text-muted">
            <div>PnL: <span th:text="${s.totalProfitPct}">‚Äî</span>%</div>
            <div>ML –¥–æ–≤–µ—Ä–∏–µ: <span th:text="${s.mlConfidence}">‚Äî</span></div>
          </div>

          <div class="mt-4 d-grid gap-2">

            <!-- üöÄ –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ / –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
            <button type="button" class="btn toggle-btn"
                    th:classappend="${s.active} ? 'btn-outline-danger' : 'btn-outline-success'"
                    th:data-type="${s.strategyType}"
                    th:data-chat-id="${s.chatId != null ? s.chatId : 1}"
                    th:data-symbol="${s.symbol != null ? s.symbol : 'BTCUSDT'}"
                    th:data-active="${s.active}">
              <i th:class="${s.active} ? 'bi bi-stop-fill' : 'bi bi-play-fill'"></i>
              <span th:text="${s.active} ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å'">–ó–∞–ø—É—Å—Ç–∏—Ç—å</span>
            </button>

            <!-- ‚öôÔ∏è –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <a th:href="@{|/strategies/${s.strategyType.toLowerCase()}/settings|}"
               class="btn btn-outline-primary">
              <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üìú JS-—Å–∫—Ä–∏–ø—Ç -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.preventDefault();

          const card = btn.closest(".card"); // —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
          const badge = card?.querySelector(".badge"); // –±–µ–π–¥–∂ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
          const chatId = btn.dataset.chatId || 1;
          const type = btn.dataset.type;
          const symbol = btn.dataset.symbol || "BTCUSDT";
          const active = btn.dataset.active === "true";

          btn.disabled = true;
          const icon = btn.querySelector("i");
          const label = btn.querySelector("span");

          if (icon && label) {
            icon.className = active ? "bi bi-stop-fill" : "bi bi-play-fill";
            label.textContent = active ? " –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..." : " –ó–∞–ø—É—Å–∫–∞–µ–º...";
          }

          try {
            const res = await fetch(`/api/strategy/toggle?chatId=${chatId}&type=${type}&symbol=${symbol}`, {
              method: "POST",
              headers: { "Accept": "application/json" }
            });

            const contentType = res.headers.get("content-type") || "";
            const data = contentType.includes("application/json")
                    ? await res.json()
                    : JSON.parse(await res.text());

            if (!res.ok || data.status === "error") {
              throw new Error(data.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏");
            }

            const started = data.status === "started";
            btn.dataset.active = String(started);

            // üîÑ –º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏
            btn.classList.toggle("btn-outline-success", !started);
            btn.classList.toggle("btn-outline-danger", started);
            if (icon) icon.className = started ? "bi bi-stop-fill" : "bi bi-play-fill";
            if (label) label.textContent = started ? " –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : " –ó–∞–ø—É—Å—Ç–∏—Ç—å";

            // ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
            if (badge) {
              badge.textContent = started ? "üü¢ –ê–∫—Ç–∏–≤–Ω–∞" : "‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
              badge.classList.toggle("bg-success", started);
              badge.classList.toggle("bg-secondary", !started);
            }

            if (window.showToast)
              showToast(started ? "‚úÖ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–ø—É—â–µ–Ω–∞" : "üõë –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", true);

            // –†–µ–¥–∏—Ä–µ–∫—Ç ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –µ–≥–æ –ø—Ä–∏—Å–ª–∞–ª
            if (data.redirect) window.location.href = data.redirect;

          } catch (err) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏:", err);
            if (window.showToast)
              showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏", false);
          } finally {
            btn.disabled = false;
          }
        });
      });
    });
  </script>




</section>

</body>
</html>
