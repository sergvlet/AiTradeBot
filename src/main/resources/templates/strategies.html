<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body th:replace="~{layout :: layout(~{::title}, ~{::section}, 'strategies')}">

<section>

  <style>
    .strategy-card {
      background: #15171a !important;
      border: 1px solid #2b2e33;
      border-radius: 14px;
      color: #f1f1f1 !important;
      transition: .25s;
    }

    .strategy-card:hover {
      transform: translateY(-3px);
      border-color: #3c8aff;
      box-shadow: 0 14px 30px rgba(0, 0, 0, .55);
    }

    .strategy-title {
      color: #f9fafb !important;
      font-weight: 600;
    }

    .strategy-card .small {
      color: #a0aec0 !important;
    }

    .pnl-green {
      color: #14c784 !important;
    }

    .pnl-red {
      color: #ff5b5b !important;
    }
  </style>

  <h2 class="fw-bold mb-4">
    <i class="bi bi-diagram-3"></i> –°—Ç—Ä–∞—Ç–µ–≥–∏–∏
  </h2>

  <div class="row g-4">

    <!-- –û–î–ù–ê –ö–ê–†–¢–û–ß–ö–ê –ù–ê –°–¢–†–ê–¢–ï–ì–ò–Æ -->
    <div class="col-md-4 col-sm-6" th:each="s : ${strategies}">

      <div class="card strategy-card h-100 shadow-sm"
           th:classappend="${s.active} ? ' border-success border-2' : ''">

        <div class="card-body text-center">

          <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
          <h5 class="strategy-title mb-2" th:text="${s.title}">Strategy</h5>

          <!-- –°—Ç–∞—Ç—É—Å -->
          <span class="badge px-3 py-2 mb-2"
                th:classappend="${s.active} ? ' bg-success' : ' bg-secondary'">
                        <span th:text="${s.active} ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'">‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</span>
                    </span>

          <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–∞ -->
          <div class="small">
            <div>
              PnL:
              <span th:text="${s.totalProfitPct}"
                    th:classappend="${s.totalProfitPct >= 0} ? ' pnl-green' : ' pnl-red'">0</span>%
            </div>
            <div>ML –¥–æ–≤–µ—Ä–∏–µ: <strong th:text="${s.mlConfidence}">0</strong></div>
            <div>–ü–∞—Ä–∞: <strong th:text="${s.symbol}">BTCUSDT</strong></div>
            <div>–°–µ—Ç—å: <strong th:text="${s.networkType}">MAINNET</strong></div>
          </div>

          <!-- –ö–ù–û–ü–ö–ò -->
          <div class="mt-4 d-grid gap-2">

            <!-- üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å / –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å -->
            <button type="button"
                    class="btn toggle-btn"
                    th:classappend="${s.active} ? ' btn-outline-danger' : ' btn-outline-success'"
                    th:data-type="${s.strategyType}"
                    th:data-chat-id="${s.chatId}"
                    th:data-symbol="${s.symbol}"
                    th:data-active="${s.active}">
              <i th:class="${s.active} ? 'bi bi-stop-fill' : 'bi bi-play-fill'"></i>
              <span th:text="${s.active} ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å'">–ó–∞–ø—É—Å—Ç–∏—Ç—å</span>
            </button>

            <!-- üìä –î–∞—à–±–æ—Ä–¥ -->
            <a class="btn btn-outline-primary"
               th:href="@{'/strategies/' + ${s.strategyType} + '/dashboard'(chatId=${s.chatId}, symbol=${s.symbol})}">
              <i class="bi bi-graph-up"></i> –î–∞—à–±–æ—Ä–¥
            </a>

            <!-- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <a class="btn btn-outline-primary"
               th:href="@{'/strategies/' + ${s.strategyType} + '/unified-settings'(chatId=${s.chatId})}">
              <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </a>

          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- =========================== JS: TOGGLE =========================== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      document.querySelectorAll(".toggle-btn").forEach(btn => {

        btn.addEventListener("click", async (e) => {
          e.preventDefault();

          const chatId = btn.dataset.chatId;
          const type = btn.dataset.type;
          const symbol = btn.dataset.symbol;
          const active = btn.dataset.active === "true";

          const card = btn.closest(".card");
          const badge = card.querySelector(".badge");
          const icon = btn.querySelector("i");
          const label = btn.querySelector("span");

          btn.disabled = true;

          // –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
          label.textContent = active ? "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..." : "–ó–∞–ø—É—Å–∫–∞–µ–º...";
          icon.className = "bi bi-hourglass-split";

          try {
            const response = await fetch(
                    `/api/strategy/toggle?chatId=${chatId}&type=${type}&symbol=${symbol}`,
                    { method: "POST" }
            );

            const data = await response.json();

            if (!response.ok || data.status === "error") {
              throw new Error(data.message || "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è");
            }

            const started = data.status === "started";
            btn.dataset.active = String(started);

            // –∫–Ω–æ–ø–∫–∞
            btn.classList.toggle("btn-outline-success", !started);
            btn.classList.toggle("btn-outline-danger", started);
            icon.className = started ? "bi bi-stop-fill" : "bi bi-play-fill";
            label.textContent = started ? "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–ó–∞–ø—É—Å—Ç–∏—Ç—å";

            // –±–µ–π–¥–∂
            if (badge) {
              badge.textContent = started ? "üü¢ –ê–∫—Ç–∏–≤–Ω–∞" : "‚ö´ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
              badge.classList.toggle("bg-success", started);
              badge.classList.toggle("bg-secondary", !started);
            }

            // —Ç–≤–æ–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (window.showToast) {
              showToast(started ? "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–ø—É—â–µ–Ω–∞" : "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", started);
            }

            // –µ—Å–ª–∏ –±–µ–∫ –æ—Ç–¥–∞—Å—Ç redirect
            if (data.redirect) {
              window.location.href = data.redirect;
            }

          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏", err);
            if (window.showToast) {
              showToast("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏", false);
            }
          } finally {
            btn.disabled = false;
          }
        });

      });

    });
  </script>

</section>

</body>
</html>
