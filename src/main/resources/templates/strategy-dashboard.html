<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::section}, 'strategies')}">

<head>
  <meta charset="UTF-8"/>
  <title th:text="'–°—Ç—Ä–∞—Ç–µ–≥–∏—è: ' + ${type} + ' ‚Ä¢ ' + (${symbol} ?: '‚Äî')">AI Trading Dashboard</title>
</head>

<body>

<section id="strategy-dashboard"
         th:with="info=${info}, type=${type}, symbol=${symbol}, chatId=${chatId}"
         th:attr="data-chat-id=${chatId},
                  data-type=${type},
                  data-symbol=${symbol},
                  data-exchange=${'BINANCE'},
                  data-network=${info != null and info.networkType != null ? info.networkType : 'MAINNET'},
                  data-timeframe=${info != null and info.timeframe != null ? info.timeframe : '15m'}">

  <!-- HEADER =============================================================== -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div class="d-flex flex-wrap align-items-center gap-3">
      <div>
        <div class="section-title mb-1">AI Trading Dashboard</div>
        <h2 class="fw-bold mb-0">
          <i class="bi bi-cpu text-info me-2"></i>
          <span th:text="${type}">SMART_FUSION</span>
        </h2>
      </div>

      <div class="vr d-none d-md-block mx-3"></div>

      <div>
        <div class="small-label mb-1">–°–∏–º–≤–æ–ª</div>
        <span class="pill-badge bg-primary-subtle text-primary-emphasis"
              th:text="${symbol} ?: '‚Äî'">BTCUSDT</span>
      </div>

      <div class="vr d-none d-md-block mx-3"></div>

      <div>
        <div class="small-label mb-1">–°—Ç–∞—Ç—É—Å</div>
        <span class="pill-badge"
              th:classappend="${info != null and info.running}
              ? ' bg-success-subtle text-success-emphasis'
              : ' bg-danger-subtle text-danger-emphasis'">
          <span class="status-dot"
                th:classappend="${info != null and info.running} ? ' status-dot-running'
                                                                 : ' status-dot-stopped'"></span>
          <span th:text="${info != null and info.running} ? '–†–∞–±–æ—Ç–∞–µ—Ç' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'">–†–∞–±–æ—Ç–∞–µ—Ç</span>
        </span>
      </div>
    </div>

    <div class="d-flex flex-wrap align-items-center gap-2 mt-3 mt-md-0">
      <div class="badge-network">
        <i class="bi bi-hdd-network me-1"></i>
        <span th:text="${info != null and info.networkType != null} ? info.networkType : 'UNKNOWN'">MAINNET</span>
      </div>

      <button class="btn-toggle btn-run"
              th:if="${info == null || !info.running}"
              th:data-chat-id="${chatId}"
              th:data-type="${type}"
              id="btn-start">
        <i class="bi bi-play-fill me-1"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å
      </button>

      <button class="btn-toggle btn-stop"
              th:if="${info != null && info.running}"
              th:data-chat-id="${chatId}"
              th:data-type="${type}"
              id="btn-stop">
        <i class="bi bi-stop-fill me-1"></i>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- MARKET SNAPSHOT ====================================================== -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card-theme p-2 h-100">
        <div class="small-label mb-1">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
        <div class="fs-5 fw-semibold" id="stat-last-price">‚Äî</div>
        <div class="metric-sub" th:text="${symbol} ?: '‚Äî'">BTCUSDT</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card-theme p-2 h-100">
        <div class="small-label mb-1">–ò–∑–º–µ–Ω–µ–Ω–∏–µ (–¥–∏–∞–ø–∞–∑–æ–Ω –≥—Ä–∞—Ñ–∏–∫–∞)</div>
        <div class="fs-6 fw-semibold" id="stat-change-pct">‚Äî</div>
        <div class="metric-sub">–æ—Ç –ø–µ—Ä–≤–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card-theme p-2 h-100">
        <div class="small-label mb-1">–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω</div>
        <div class="fs-6 fw-semibold" id="stat-range">‚Äî</div>
        <div class="metric-sub">min‚Äìmax –Ω–∞ —Ç–µ–∫—É—â–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card-theme p-2 h-100">
        <div class="small-label mb-1">–¢—Ä–µ–Ω–¥</div>
        <div class="fs-6 fw-semibold" id="stat-trend">‚Äî</div>
        <div class="metric-sub">–ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ü–µ–Ω—ã</div>
      </div>
    </div>
  </div>

  <!-- TOP ROW =============================================================== -->
  <div class="row g-4 mb-4">

    <!-- CHART -->
    <div class="col-lg-8">
      <div class="card-theme p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">

          <div>
            <div class="small-label mb-1">–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã</div>
            <h5 class="mb-0">
              <i class="bi bi-graph-up-arrow text-info me-2"></i>
              <span th:text="${symbol} ?: '–ì—Ä–∞—Ñ–∏–∫'">BTCUSDT</span>
            </h5>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="d-flex align-items-center gap-1">
              <span class="small-label me-1">–¢–∞–π–º—Ñ—Ä–µ–π–º</span>
              <label for="timeframe-select"></label>
              <select id="timeframe-select"
                      class="form-select form-select-sm"
                      style="min-width: 90px;">
                <option value="">‚Ä¶</option>
              </select>
            </div>
            <!-- üîµ WebSocket LIVE —Å—Ç–∞—Ç—É—Å -->
            <div class="d-flex align-items-center gap-1">
              <span class="small-label">WS:</span>
              <span id="live-status"
                    style="font-weight:bold;color:#e74c3c;">
                OFFLINE
              </span>
            </div>
            <!-- –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PNG (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—à—å –ø–æ–∑–∂–µ) -->
            <button class="btn btn-sm btn-outline-light border-opacity-25" id="btn-export-png" type="button">
              <i class="bi bi-download"></i>
            </button>
          </div>
        </div>

        <div class="chart-wrapper-main">
          <div id="candles-chart"></div>
        </div>
      </div>
    </div>

    <!-- METRICS -->
    <div class="col-lg-4">

      <div class="card-theme p-3 mb-3">
        <div class="small-label mb-2">P&L –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>

        <div class="row g-3">

          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="metric-label mb-1">ROI / –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
                <div class="metric-value"
                     th:classappend="${info != null and info.totalProfitPct != null and info.totalProfitPct >= 0}
                                     ? ' metric-positive' : ' metric-negative'"
                     th:text="${(info != null and info.totalProfitPct != null)
                                 ? #numbers.formatDecimal(info.totalProfitPct,1,2) + '%'
                                 : '0.00%'}">0.00%</div>
              </div>
              <i class="bi bi-activity fs-3 text-info"></i>
            </div>
            <div class="metric-sub mt-1">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º.</div>
          </div>

          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="metric-label mb-1">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                <div class="metric-value text-info"
                     th:text="${(info != null and info.currentEquity != null)
                                  ? #numbers.formatDecimal(info.currentEquity,1,2)
                                  : '‚Äî'}">‚Äî</div>
              </div>
              <div class="text-end">
                <div class="metric-label mb-1">–°—Ç–∞—Ä—Ç–æ–≤—ã–π</div>
                <div class="metric-sub"
                     th:text="${(info != null and info.initialEquity != null)
                                  ? #numbers.formatDecimal(info.initialEquity,1,2)
                                  : '‚Äî'}">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="metric-label mb-1">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                <div class="metric-value"
                     th:text="${(info != null and info.totalTrades != null) ? info.totalTrades : 0}">0</div>
              </div>
              <div class="text-end">
                <div class="metric-label mb-1">Win rate</div>
                <div class="metric-sub"
                     th:text="${(info != null and info.winRatePct != null)
                                  ? #numbers.formatDecimal(info.winRatePct,1,1) + '%'
                                  : '‚Äî'}">‚Äî</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="card-theme p-3">
        <div class="small-label mb-2">AI —Å–ª–æ–π</div>
        <p class="small text-secondary mb-2">
          –ú–µ—Ç–∞-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä—ã–Ω–æ–∫, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —à—É–º –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
        </p>
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="text-secondary small">ML/AI confidence</span>
          <span class="fw-semibold"
                th:text="${(info != null and info.mlConfidence != null)
                            ? #numbers.formatDecimal(info.mlConfidence,1,3)
                            : '‚Äî'}">‚Äî</span>
        </div>
        <div class="small text-secondary">
          <span class="text-secondary">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É:</span>
          <span class="ms-1 fw-semibold"
                th:text="${(info != null and info.riskPerTradePct != null)
                            ? #numbers.formatDecimal(info.riskPerTradePct,1,2) + '%'
                            : '‚Äî'}">‚Äî</span>
        </div>
      </div>

    </div>
  </div>

  <!-- BOTTOM ROW (Settings + Trades table) ================================= -->
  <div class="row g-4 mb-4">

    <!-- LEFT SETTINGS -->
    <div class="col-lg-4">
      <div class="card-theme p-3 mb-3">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
          <span class="badge bg-info-subtle text-info-emphasis">
              <i class="bi bi-gear-wide-connected me-1"></i>
              <span th:text="${(info != null and info.version != null) ? 'v' + info.version : 'v1'}">v1</span>
          </span>
        </div>

        <ul class="list-unstyled mb-0 small">
          <li class="mb-1">
            <span class="text-secondary">–°–∏–º–≤–æ–ª:</span>
            <span class="ms-1 fw-semibold" th:text="${symbol} ?: '‚Äî'">BTCUSDT</span>
          </li>
          <li class="mb-1">
            <span class="text-secondary">–¢–∞–π–º—Ñ—Ä–µ–π–º:</span>
            <span class="ms-1 fw-semibold"
                  th:text="${(info != null and info.timeframe != null) ? info.timeframe : '‚Äî'}">15m</span>
          </li>
          <li class="mb-1">
            <span class="text-secondary">TP / SL:</span>
            <span class="ms-1 fw-semibold"
                  th:text="${(info != null and info.tpPct != null)
                              ? #numbers.formatDecimal(info.tpPct,1,2) + '% / ' +
                                #numbers.formatDecimal(info.slPct,1,2) + '%'
                              : '‚Äî'}">‚Äî</span>
          </li>
          <li class="mb-1">
            <span class="text-secondary">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É:</span>
            <span class="ms-1 fw-semibold"
                  th:text="${(info != null and info.riskPerTradePct != null)
                              ? #numbers.formatDecimal(info.riskPerTradePct,1,2) + '%'
                              : '‚Äî'}">‚Äî</span>
          </li>
        </ul>
      </div>

    </div>

    <!-- TRADES TABLE ======================================================= -->
    <div class="col-lg-8">
      <div class="card-theme p-3 h-100 d-flex flex-column">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small-label">–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫</div>
          <div class="d-flex gap-2">
            <span class="badge bg-success-subtle text-success-emphasis">
                <i class="bi bi-arrow-up-right-circle me-1"></i>
                –ü—Ä–æ—Ñ–∏—Ç:
                <span th:text="${(info != null and info.totalProfitPct != null)
                                  ? #numbers.formatDecimal(info.totalProfitPct,1,2) + '%'
                                  : '0.00%'}">0.00%</span>
            </span>
          </div>
        </div>

        <div class="table-responsive flex-grow-1" style="max-height:260px;overflow-y:auto;">
          <table class="table table-sm align-middle table-dark-custom mb-0">
            <thead class="sticky-top" style="background:#050814;">
            <tr>
              <th class="text-secondary small">–í—Ä–µ–º—è</th>
              <th class="text-secondary small">–¢–∏–ø</th>
              <th class="text-secondary small">–¶–µ–Ω–∞</th>
              <th class="text-secondary small">–û–±—ä—ë–º</th>
              <th class="text-secondary small">P&L</th>
            </tr>
            </thead>

            <tbody>

            <tr th:each="t : ${trades}">

              <!-- TIME -->
              <td class="small"
                  th:text="${t.timestamp != null
                  ? #temporals.format(@timeUtil.fromMillis(t.timestamp),'dd.MM HH:mm')
                  : (t.createdAt != null
                       ? #temporals.format(t.createdAt,'dd.MM HH:mm')
                       : '‚Äî')}">
              </td>

              <!-- SIDE -->
              <td>
                <span th:if="${t.side == 'BUY'}"
                      class="badge-trade-buy small px-2 py-1">
                  <i class="bi bi-arrow-up-right me-1"></i>BUY
                </span>

                <span th:if="${t.side == 'SELL'}"
                      class="badge-trade-sell small px-2 py-1">
                  <i class="bi bi-arrow-down-right me-1"></i>SELL
                </span>
              </td>

              <!-- PRICE -->
              <td class="small"
                  th:text="${#numbers.formatDecimal(t.price,1,4)}">0.0000</td>

              <!-- QUANTITY (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ qty ‚Üí quantity) -->
              <td class="small"
                  th:text="${#numbers.formatDecimal(t.quantity,1,4)}">0.0000</td>

              <!-- PNL -->
              <td class="small"
                  th:classappend="${t.realizedPnlUsd != null and t.realizedPnlUsd >= 0}
                        ? ' text-success'
                        : ' text-danger'"
                  th:text="${t.realizedPnlUsd != null
                 ? #numbers.formatDecimal(t.realizedPnlUsd,1,4)
                 : '0.0000'}">
              </td>

            </tr>

            <tr th:if="${trades == null or #lists.isEmpty(trades)}">
              <td colspan="5" class="text-center text-secondary small py-4">
                –°–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.
              </td>
            </tr>

            </tbody>

          </table>
        </div>
      </div>
    </div>

  </div>

</section>


</body>
</html>
