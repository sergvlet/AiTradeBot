<!-- templates/views/strategies/settings.html -->
<div th:fragment="content"
     class="container py-4 strategy-settings-page"
     th:with="
        chatId=${chatId},
        type=${type},
        strategy=${strategy},
        exchangeSettings=${exchangeSettings},
        connectionOk=${connectionOk},
        selectedExchange=${selectedExchange},
        selectedNetwork=${selectedNetwork},
        diagnostics=${diagnostics},
        availableExchanges=${availableExchanges},
        usdtBalance=${usdtBalance},
        availableTimeframes=${availableTimeframes}
     "
     th:attr="data-chat-id=${chatId}, data-type=${type}">

    <!-- LOCAL PAGE CSS -->
    <link rel="stylesheet" th:href="@{/css/views/strategies/settings.css}"/>

    <h2 class="fw-bold mb-4">
        <i class="bi bi-gear-wide-connected"></i>
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Äî <span th:text="${type}">TYPE</span>
    </h2>

    <!-- ==================== –§–û–†–ú–ê ==================== -->
    <form method="post"
          th:action="@{|/strategies/${type}/config?chatId=${chatId}|}"
          class="card card-theme p-4">

        <!-- ====================== –¢–ê–ë–´ ====================== -->
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><span class="nav-link tab-btn active" data-tab="tab-network">–°–µ—Ç—å</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="tab-general">–û–±—â–∏–µ</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="tab-risk">–†–∏—Å–∫</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="tab-trade">–¢–æ—Ä–≥–æ–≤–ª—è</span></li>
            <li class="nav-item"><span class="nav-link tab-btn" data-tab="tab-advanced">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ</span></li>
        </ul>

        <!-- ===================================================== -->
        <!-- ====================== NETWORK TAB ================== -->
        <!-- ===================================================== -->
        <div class="tab-pane active" id="tab-network">

            <div class="section-title">–ë–∏—Ä–∂–∞ –∏ —Å–µ—Ç—å</div>

            <div class="row g-4">

                <!-- –ë–∏—Ä–∂–∞ -->
                <div class="col-md-4">
                    <label class="form-label">–ë–∏—Ä–∂–∞</label>
                    <select id="exchangeSelect" class="form-control" name="exchange">
                        <option th:each="ex : ${availableExchanges}"
                                th:value="${ex}"
                                th:text="${ex}"
                                th:selected="${selectedExchange == ex}"></option>
                    </select>
                </div>

                <!-- –°–µ—Ç—å -->
                <div class="col-md-4">
                    <label class="form-label">–°–µ—Ç—å</label>
                    <select id="networkSelect" class="form-control" name="network">
                        <option value="MAINNET" th:selected="${selectedNetwork?.name() == 'MAINNET'}">MAINNET</option>
                        <option value="TESTNET" th:selected="${selectedNetwork?.name() == 'TESTNET'}">TESTNET</option>
                    </select>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <div class="col-md-4 d-flex flex-column justify-content-end">
                    <div class="fw-bold mb-1"
                         th:classappend="${connectionOk} ? 'text-success' : 'text-danger'">
                        <span th:text="${connectionOk} ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'"></span>
                    </div>

                    <div>
                        <span class="badge bg-success" th:if="${exchangeSettings?.apiKey != null}">
                            –ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
                        </span>
                        <span class="badge bg-secondary" th:if="${exchangeSettings?.apiKey == null}">
                            –ö–ª—é—á–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
                        </span>
                    </div>
                </div>

            </div>

            <div class="section-title mt-4">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API</div>

            <div id="diagnostics-box">

                <div th:if="${selectedExchange != 'BINANCE'}" class="text-warning">
                    –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Binance.
                </div>

                <div th:if="${selectedExchange == 'BINANCE'}">

                    <div th:if="${diagnostics == null}" class="text-secondary">
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
                    </div>

                    <table th:if="${diagnostics != null}"
                           class="table table-dark table-bordered align-middle text-center mt-2"
                           style="max-width:600px;">
                        <tbody>

                        <tr><td>API Key –≤–∞–ª–∏–¥–µ–Ω</td>
                            <td th:text="${diagnostics.apiKeyValid ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.apiKeyValid} ? 'text-success' : 'text-danger'"></td></tr>

                        <tr><td>Secret –≤–∞–ª–∏–¥–µ–Ω</td>
                            <td th:text="${diagnostics.secretValid ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.secretValid} ? 'text-success' : 'text-danger'"></td></tr>

                        <tr><td>–ü–æ–¥–ø–∏—Å—å</td>
                            <td th:text="${diagnostics.signatureValid ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.signatureValid} ? 'text-success' : 'text-danger'"></td></tr>

                        <tr><td>–î–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É</td>
                            <td th:text="${diagnostics.accountReadable ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.accountReadable} ? 'text-success' : 'text-danger'"></td></tr>

                        <tr><td>–†–∞–∑—Ä–µ—à–µ–Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—è</td>
                            <td th:text="${diagnostics.tradingAllowed ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.tradingAllowed} ? 'text-success' : 'text-danger'"></td></tr>

                        <tr><td>IP —Ä–∞–∑—Ä–µ—à—ë–Ω</td>
                            <td th:text="${diagnostics.ipAllowed ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.ipAllowed} ? 'text-success' : 'text-danger'"></td></tr>

                        <tr><td>–°–µ—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞</td>
                            <td th:text="${diagnostics.networkOk ? '‚úî' : '‚úñ'}"
                                th:classappend="${diagnostics.networkOk} ? 'text-success' : 'text-danger'"></td></tr>

                        </tbody>
                    </table>

                </div>

            </div>

            <div class="section-title mt-4">API –∫–ª—é—á–∏</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">API Key</label>
                    <input class="form-control"
                           name="apiKey"
                           th:value="${exchangeSettings?.apiKey}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">API Secret</label>
                    <input class="form-control"
                           name="apiSecret"
                           th:value="${exchangeSettings?.apiSecret}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Passphrase</label>
                    <input class="form-control"
                           name="passphrase"
                           th:value="${exchangeSettings?.passphrase}">
                </div>

            </div>

        </div>

        <!-- ===================================================== -->
        <!-- ====================== GENERAL TAB ================== -->
        <!-- ===================================================== -->
        <div class="tab-pane" id="tab-general">

            <div class="section-title">–ö–∞–ø–∏—Ç–∞–ª –∏ –∫–æ–º–∏—Å—Å–∏—è</div>

            <div class="row g-4">
                <div class="col-md-4">
                    <label class="form-label">–ö–∞–ø–∏—Ç–∞–ª (USDT)</label>
                    <input type="number" step="0.01" class="form-control"
                           name="capitalUsd"
                           th:value="${strategy.capitalUsd}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–ö–æ–º–∏—Å—Å–∏—è (%)</label>
                    <input class="form-control"
                           step="0.001" type="number"
                           name="commissionPct"
                           th:value="${strategy.commissionPct}">

                    <button id="refreshFeeBtn" type="button"
                            class="btn btn-outline-info btn-sm mt-3">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é
                    </button>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <label class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               name="reinvestProfit"
                               th:checked="${strategy.reinvestProfit}">
                        <span class="ms-2">–†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å</span>
                    </label>
                </div>
            </div>

        </div>

        <!-- ===================================================== -->
        <!-- ====================== RISK TAB ===================== -->
        <!-- ===================================================== -->
        <div class="tab-pane" id="tab-risk">

            <div class="section-title">–†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="riskPerTradePct"
                           th:value="${strategy.riskPerTradePct}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –ø–æ—Ç–µ—Ä—å (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="dailyLossLimitPct"
                           th:value="${strategy.dailyLossLimitPct}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–ü–ª–µ—á–æ</label>
                    <input type="number" min="1"
                           class="form-control"
                           name="leverage"
                           th:value="${strategy.leverage}">
                </div>

            </div>

            <div class="section-title">TP / SL</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">Take Profit (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="takeProfitPct"
                           th:value="${strategy.takeProfitPct}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Stop Loss (%)</label>
                    <input type="number" step="0.1"
                           class="form-control"
                           name="stopLossPct"
                           th:value="${strategy.stopLossPct}">
                </div>

            </div>

        </div>

        <!-- ===================================================== -->
        <!-- ====================== TRADE TAB ==================== -->
        <!-- ===================================================== -->
        <div class="tab-pane" id="tab-trade">

            <div class="section-title">–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞</div>

            <div class="row g-4">

                <div class="col-md-4">
                    <label class="form-label">–ü–∞—Ä–∞</label>
                    <input id="symbolInput" class="form-control"
                           name="symbol"
                           th:value="${strategy.symbol}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">–¢–∞–π–º—Ñ—Ä–µ–π–º</label>
                    <select class="form-select" name="timeframe">
                        <option th:each="tf : ${availableTimeframes}"
                                th:text="${tf}"
                                th:selected="${strategy.timeframe == tf}"></option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">–°–≤–µ—á–µ–π –≤ –∫—ç—à–µ</label>
                    <input type="number"
                           class="form-control"
                           min="100" max="5000" step="50"
                           name="cachedCandlesLimit"
                           th:value="${strategy.cachedCandlesLimit}">
                </div>

            </div>

            <hr class="my-4"/>

            <div class="section-title">–ü–æ–∏—Å–∫ –º–æ–Ω–µ—Ç</div>

            <input id="marketSearch"
                   class="form-control mb-3"
                   placeholder="BTC, ETH, XRP‚Ä¶">

            <div id="marketResults" class="market-results-box">
                <div class="text-center text-secondary p-3">
                    –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å‚Ä¶
                </div>
            </div>

        </div>

        <!-- ===================================================== -->
        <!-- ====================== ADVANCED TAB ================= -->
        <!-- ===================================================== -->
        <div class="tab-pane" id="tab-advanced">

            <div class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>

            <div class="alert alert-secondary small">
                –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ML/RL –∏ SmartFusion.
            </div>

        </div>

        <!-- ==================== SUBMIT ===================== -->
        <hr class="my-4"/>

        <div class="d-flex gap-3">
            <a href="/strategies" class="btn btn-outline-secondary">
                ‚óÄ –ù–∞–∑–∞–¥
            </a>

            <button type="submit" class="btn btn-primary px-4">
                ‚úî –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>

    </form>

    <!-- LOCAL PAGE JS -->
    <script th:src="@{/js/views/strategies/settings.js}"></script>

</div>
