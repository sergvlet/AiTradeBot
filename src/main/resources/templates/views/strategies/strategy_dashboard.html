<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="content"
     th:with="
        type=${type},
        chatId=${chatId},
        symbolSafe=${symbol != null ? #strings.trim(symbol) : ''},
        hasSymbol=${!#strings.isEmpty(symbolSafe)},
        infoSafe=${info},
        activeSafe=${infoSafe != null and infoSafe.active},
        exchangeSafe=${(infoSafe != null and infoSafe.exchangeName != null) ? infoSafe.exchangeName : 'BINANCE'},
        networkSafe=${(infoSafe != null and infoSafe.networkType != null) ? infoSafe.networkType : 'MAINNET'},
        tfSafe=${(infoSafe != null and infoSafe.timeframe != null) ? infoSafe.timeframe : ''}
     ">

    <!-- ROOT –î–õ–Ø JS -->
    <div id="strategy-root"
         th:attr="
            data-chat-id=${chatId},
            data-type=${type},
            data-symbol=${hasSymbol ? symbolSafe : ''}
         ">
    </div>

    <!-- =========================================
         ‚ö†Ô∏è NOT CONFIGURED WARNING
         ========================================= -->
    <div th:if="${!hasSymbol}"
         class="alert alert-warning d-flex align-items-center gap-2 mb-4"
         role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div>
            <b>–°—Ç—Ä–∞—Ç–µ–≥–∏—è –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.</b>
            –û—Ç–∫—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —É–∫–∞–∂–∏ —Ö–æ—Ç—è –±—ã <b>—Å–∏–º–≤–æ–ª</b> –∏ <b>—Ç–∞–π–º—Ñ—Ä–µ–π–º</b>.
        </div>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-graph-up"></i>
                <span th:text="${type}">STRATEGY</span> ‚Äî –î–∞—à–±–æ—Ä–¥
            </h2>

            <div class="text-secondary">
                –°–∏–º–≤–æ–ª:
                <span class="fw-semibold"
                      th:text="${hasSymbol ? symbolSafe : '‚Äî –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ ‚Äî'}">BTCUSDT</span>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">

            <!-- STATUS -->
            <span class="badge px-3 py-2"
                  th:classappend="${activeSafe} ? ' bg-success' : ' bg-danger'">
                <span th:text="${activeSafe} ? 'üü¢ –†–∞–±–æ—Ç–∞–µ—Ç' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'">‚Äî</span>
            </span>

            <!-- ‚ñ∂ START (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –∞–∫—Ç–∏–≤–Ω–∞ –∏ –ï–°–¢–¨ —Å–∏–º–≤–æ–ª) -->
            <form method="post"
                  th:action="@{/strategies/toggle}"
                  th:if="${!activeSafe}"
                  th:classappend="${!hasSymbol} ? ' opacity-50 pe-none' : ''">

                <input type="hidden" name="chatId" th:value="${chatId}">
                <input type="hidden" name="type" th:value="${type}">
                <input type="hidden" name="exchange" th:value="${exchangeSafe}">
                <input type="hidden" name="network" th:value="${networkSafe}">

                <button type="submit"
                        class="btn btn-outline-success"
                        th:disabled="${!hasSymbol}"
                        th:attr="title=${hasSymbol} ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å' : '–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—é'">
                    <i class="bi bi-play-fill"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                </button>
            </form>

            <!-- ‚èπ STOP (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞) -->
            <form method="post"
                  th:action="@{/strategies/toggle}"
                  th:if="${activeSafe}">

                <input type="hidden" name="chatId" th:value="${chatId}">
                <input type="hidden" name="type" th:value="${type}">
                <input type="hidden" name="exchange" th:value="${exchangeSafe}">
                <input type="hidden" name="network" th:value="${networkSafe}">

                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-stop-fill"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                </button>
            </form>

        </div>
    </div>

    <!-- –ö–ê–†–¢–û–ß–ö–ò -->
    <div class="row g-4 mb-4">

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">ROI</div>
                <div class="fs-4 fw-bold"
                     th:classappend="${infoSafe != null and infoSafe.totalProfitPct != null and infoSafe.totalProfitPct >= 0} ? ' text-success' : ' text-danger'"
                     th:text="${infoSafe != null and infoSafe.totalProfitPct != null ? infoSafe.totalProfitPct + '%' : '‚Äî'}">
                </div>
                <div class="text-secondary small">–û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">AI Confidence</div>
                <div class="fs-4 fw-bold"
                     th:text="${infoSafe != null and infoSafe.mlConfidence != null ? infoSafe.mlConfidence : '‚Äî'}">
                </div>
                <div class="text-secondary small">–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ AI</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">TP / SL</div>
                <div class="fs-5 fw-bold">
                    <span th:text="${infoSafe != null and infoSafe.takeProfitPct != null ? infoSafe.takeProfitPct : '‚Äî'}">‚Äî</span>% /
                    <span th:text="${infoSafe != null and infoSafe.stopLossPct != null ? infoSafe.stopLossPct : '‚Äî'}">‚Äî</span>%
                </div>
                <div class="text-secondary small">Take / Stop</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">–†–∏—Å–∫ / —Å–¥–µ–ª–∫—É</div>
                <div class="fs-4 fw-bold"
                     th:text="${infoSafe != null and infoSafe.riskPerTradePct != null ? infoSafe.riskPerTradePct + '%' : '‚Äî'}">
                </div>
                <div class="text-secondary small">Risk per trade</div>
            </div>
        </div>

    </div>

    <!-- –ì–†–ê–§–ò–ö -->
    <div class="card card-theme p-3 mb-4" id="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart-line me-2"></i>–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã
            </h5>

            <div class="d-flex align-items-center gap-2">
                <div class="small">
                    <span class="text-secondary">WS:</span>
                    <span id="chart-ws-status" class="fw-bold text-danger">OFFLINE</span>
                </div>

                <button class="btn btn-sm btn-outline-secondary"
                        id="btn-fullscreen"
                        type="button"
                        title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                    ‚õ∂
                </button>

                <button class="btn btn-sm btn-outline-success"
                        id="btn-save-chart"
                        type="button"
                        title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                    üíæ
                </button>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="chart-controls d-flex flex-wrap gap-2 mb-3">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" type="button" onclick="window.chartCtrl?.setTimeframe?.('1m')">1m</button>
                <button class="btn btn-outline-secondary" type="button" onclick="window.chartCtrl?.setTimeframe?.('5m')">5m</button>
                <button class="btn btn-outline-secondary" type="button" onclick="window.chartCtrl?.setTimeframe?.('15m')">15m</button>
                <button class="btn btn-outline-secondary" type="button" onclick="window.chartCtrl?.setTimeframe?.('1h')">1h</button>
            </div>

            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-warning" type="button" onclick="window.chartCtrl?.addSMA?.(14)">SMA</button>
                <button class="btn btn-outline-info" type="button" onclick="window.chartCtrl?.addEMA?.(14)">EMA</button>
                <button class="btn btn-outline-success" type="button" onclick="window.chartCtrl?.addVolumeSeries?.()">VOL</button>
            </div>
        </div>

        <!-- Tooltip -->
        <div id="tooltip-date"
             style="position:absolute;top:8px;right:12px;
                background:rgba(0,0,0,.75);
                color:#fff;
                font-size:12px;
                padding:4px 8px;
                border-radius:4px;
                pointer-events:none;
                z-index:100;">
            ‚Äî
        </div>

        <div id="strategy-chart-container" style="height:400px; position:relative;">
            <div id="strategy-chart" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <script>
        (function () {
            const fsBtn = document.getElementById("btn-fullscreen");
            const card = document.getElementById("chart-card");

            if (fsBtn && card) {
                fsBtn.addEventListener("click", async () => {
                    try {
                        if (!document.fullscreenElement) {
                            await (card.requestFullscreen?.() ?? Promise.resolve());
                        } else {
                            await (document.exitFullscreen?.() ?? Promise.resolve());
                        }
                    } catch (e) {
                        console.warn("Fullscreen failed:", e);
                    }
                });
            }

            const saveBtn = document.getElementById("btn-save-chart");
            if (saveBtn) {
                saveBtn.addEventListener("click", () => {
                    try {
                        const canvas = document.querySelector("#strategy-chart canvas");
                        if (!canvas) {
                            alert("Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω (–≥—Ä–∞—Ñ–∏–∫ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è)");
                            return;
                        }
                        const link = document.createElement("a");
                        link.download = `chart_${Date.now()}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    } catch (e) {
                        console.error("Save chart failed:", e);
                    }
                });
            }

            // –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–∞—Ç—ã –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ chart —Ä–µ–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤
            const tryBindCrosshair = () => {
                if (!window.chartCtrl?.chart?.subscribeCrosshairMove) return false;

                window.chartCtrl.chart.subscribeCrosshairMove(param => {
                    const el = document.getElementById("tooltip-date");
                    if (!el) return;

                    if (!param || !param.time) {
                        el.textContent = "‚Äî";
                        return;
                    }

                    const t = (typeof param.time === "object" && param.time && "unix" in param.time)
                        ? param.time.unix
                        : param.time;

                    el.textContent = new Date(Number(t) * 1000).toISOString();
                });

                return true;
            };

            // –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫, —Ç.–∫. chartCtrl –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            let tries = 0;
            const timer = setInterval(() => {
                tries++;
                if (tryBindCrosshair() || tries >= 20) clearInterval(timer);
            }, 300);
        })();
    </script>

    <!-- –ù–ò–ñ–ù–ò–ï –ë–õ–û–ö–ò -->
    <div class="row g-4">

        <!-- –ñ–£–†–ù–ê–õ -->
        <div class="col-lg-7">
            <div class="card card-theme p-3 h-100">
                <h5 class="mb-2">
                    <i class="bi bi-list-check me-2"></i>–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫
                </h5>

                <div class="table-responsive" style="max-height:300px">
                    <table class="table table-dark-custom table-sm">
                        <thead>
                        <tr>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–¢–∏–ø</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–û–±—ä—ë–º</th>
                            <th>–ü—Ä–æ—Ñ–∏—Ç</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-secondary py-3">
                                –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="col-lg-5">
            <div class="card card-theme p-3 h-100">
                <h5 class="mb-3">
                    <i class="bi bi-gear me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                </h5>

                <ul class="list-unstyled small">
                    <li>–ë–∏—Ä–∂–∞: <b th:text="${exchangeSafe}">BINANCE</b></li>
                    <li>–°–µ—Ç—å: <b th:text="${networkSafe}">MAINNET</b></li>
                    <li>–ü–∞—Ä–∞: <b th:text="${hasSymbol ? symbolSafe : '‚Äî'}">BTCUSDT</b></li>
                    <li>–¢–§: <b th:text="${!#strings.isEmpty(tfSafe) ? tfSafe : '‚Äî'}">1m</b></li>
                    <li>–ö–æ–º–∏—Å—Å–∏—è: <b th:text="${infoSafe != null and infoSafe.commissionPct != null ? infoSafe.commissionPct : '‚Äî'}">‚Äî</b>%</li>
                </ul>

                <!-- config: –ø–µ—Ä–µ–¥–∞—ë–º chatId + (–µ—Å–ª–∏ –µ—Å—Ç—å) exchange/network -->
                <a class="btn btn-outline-primary w-100 mt-3"
                   th:href="@{'/strategies/' + ${type} + '/config'(
                        chatId=${chatId},
                        exchange=${exchangeSafe},
                        network=${networkSafe}
                   )}">
                    <i class="bi bi-pencil-square me-2"></i>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
                </a>
            </div>
        </div>

    </div>

</div>

</body>
</html>
