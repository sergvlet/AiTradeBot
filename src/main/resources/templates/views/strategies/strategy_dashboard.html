<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="content"
     th:with="
        type=${type},
        chatId=${chatId},
        symbol=${symbol},
        info=${info}
     ">

    <!-- üëá ROOT –î–õ–Ø JS -->
    <div id="strategy-root"
         th:attr="
            data-chat-id=${chatId},
            data-type=${type},
            data-symbol=${symbol}
         ">
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-graph-up"></i>
                <span th:text="${type}">STRATEGY</span> ‚Äî –î–∞—à–±–æ—Ä–¥
            </h2>

            <div class="text-secondary">
                –°–∏–º–≤–æ–ª:
                <span class="fw-semibold" th:text="${symbol}">BTCUSDT</span>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">

            <span class="badge px-3 py-2"
                  th:classappend="${info != null and info.active} ? ' bg-success' : ' bg-danger'">
                <span th:text="${info != null and info.active} ? 'üü¢ –†–∞–±–æ—Ç–∞–µ—Ç' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'">
                    ‚Äî
                </span>
            </span>

            <button id="btn-start"
                    class="btn btn-outline-success"
                    th:classappend="${info != null and info.active} ? ' d-none' : ''"
                    th:data-type="${type}"
                    th:data-chat-id="${chatId}">
                <i class="bi bi-play-fill"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
            </button>

            <button id="btn-stop"
                    class="btn btn-outline-danger"
                    th:classappend="${info == null or !info.active} ? ' d-none' : ''"
                    th:data-type="${type}"
                    th:data-chat-id="${chatId}">
                <i class="bi bi-stop-fill"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>

        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="row g-4 mb-4">

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">ROI</div>
                <div class="fs-4 fw-bold"
                     th:classappend="${info != null and info.totalProfitPct >= 0} ? ' text-success' : ' text-danger'"
                     th:text="${info != null ? info.totalProfitPct + '%' : '‚Äî'}">
                </div>
                <div class="text-secondary small">–û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">–ö–∞–ø–∏—Ç–∞–ª</div>
                <div class="fs-4 fw-bold text-info"
                     th:text="${info != null and info.equityUsd != null ? info.equityUsd : '‚Äî'}">
                </div>
                <div class="text-secondary small">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">AI Confidence</div>
                <div class="fs-4 fw-bold"
                     th:text="${info != null and info.mlConfidence != null ? info.mlConfidence : '‚Äî'}">
                </div>
                <div class="text-secondary small">–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ AI</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card card-theme p-3">
                <div class="small-label">–°–¥–µ–ª–∫–∏</div>
                <div class="fs-4 fw-bold"
                     th:text="${info != null and info.totalTrades != null ? info.totalTrades : 0}">
                </div>
                <div class="text-secondary small">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            </div>
        </div>

    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <div class="card card-theme p-3 mb-4" id="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart-line me-2"></i>–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã
            </h5>

            <div class="d-flex align-items-center gap-2">
                <div class="small">
                    <span class="text-secondary">WS:</span>
                    <span id="chart-ws-status" class="fw-bold text-danger">OFFLINE</span>
                </div>

                <!-- ‚úÖ –ö–ù–û–ü–ö–ò -->
                <button class="btn btn-sm btn-outline-secondary"
                        id="btn-fullscreen"
                        title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                    ‚õ∂
                </button>

                <button class="btn btn-sm btn-outline-success"
                        id="btn-save-chart"
                        title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                    üíæ
                </button>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="chart-controls d-flex flex-wrap gap-2 mb-3">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="window.chartCtrl?.setTimeframe('1m')">1m</button>
                <button class="btn btn-outline-secondary" onclick="window.chartCtrl?.setTimeframe('5m')">5m</button>
                <button class="btn btn-outline-secondary" onclick="window.chartCtrl?.setTimeframe('15m')">15m</button>
                <button class="btn btn-outline-secondary" onclick="window.chartCtrl?.setTimeframe('1h')">1h</button>
            </div>

            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-warning" onclick="window.chartCtrl?.addSMA?.(14)">SMA</button>
                <button class="btn btn-outline-info" onclick="window.chartCtrl?.addEMA?.(14)">EMA</button>
                <button class="btn btn-outline-success" onclick="window.chartCtrl?.addVolumeSeries?.()">VOL</button>
            </div>
        </div>

        <!-- Tooltip -->
        <div id="tooltip-date"
             style="position:absolute;top:8px;right:12px;
                background:rgba(0,0,0,.75);
                color:#fff;
                font-size:12px;
                padding:4px 8px;
                border-radius:4px;
                pointer-events:none;
                z-index:100;">
            ‚Äî
        </div>

        <div id="strategy-chart-container" style="height:400px; position:relative;">
            <div id="strategy-chart" style="width:100%; height:100%;"></div>
        </div>
    </div>
    <script>
        (function () {

            // ===============================
            // FULLSCREEN
            // ===============================
            const fsBtn = document.getElementById("btn-fullscreen");
            const card = document.getElementById("chart-card");

            if (fsBtn && card) {
                fsBtn.addEventListener("click", () => {
                    if (!document.fullscreenElement) {
                        card.requestFullscreen?.();
                    } else {
                        document.exitFullscreen?.();
                    }
                });
            }

            // ===============================
            // SAVE IMAGE
            // ===============================
            const saveBtn = document.getElementById("btn-save-chart");

            if (saveBtn) {
                saveBtn.addEventListener("click", async () => {
                    if (!window.chartCtrl?.chart) return;

                    try {
                        const canvas = document.querySelector("#strategy-chart canvas");
                        if (!canvas) return alert("Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω");

                        const link = document.createElement("a");
                        link.download = `chart_${Date.now()}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    } catch (e) {
                        console.error("Save chart failed:", e);
                    }
                });
            }

            // ===============================
            // TOOLTIP (ISO DATE)
            // ===============================
            setTimeout(() => {
                if (!window.chartCtrl?.chart) return;

                window.chartCtrl.chart.subscribeCrosshairMove(param => {
                    const el = document.getElementById("tooltip-date");
                    if (!el) return;

                    if (!param || !param.time) {
                        el.textContent = "‚Äî";
                        return;
                    }

                    const t = typeof param.time === "object"
                        ? param.time.unix
                        : param.time;

                    el.textContent = new Date(t * 1000).toISOString();
                });
            }, 800);

        })();
    </script>

    <!-- –ù–∏–∂–Ω–∏–µ –±–ª–æ–∫–∏ -->
    <div class="row g-4">

        <!-- –ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫ -->
        <div class="col-lg-7">
            <div class="card card-theme p-3 h-100">

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫
                    </h5>

                    <span class="badge bg-info">
                        PnL:
                        <span th:text="${info != null ? info.totalProfitPct + '%' : '0%'}"></span>
                    </span>
                </div>

                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-dark-custom table-sm mb-0">
                        <thead>
                        <tr>
                            <th class="text-secondary small">–í—Ä–µ–º—è</th>
                            <th class="text-secondary small">–¢–∏–ø</th>
                            <th class="text-secondary small">–¶–µ–Ω–∞</th>
                            <th class="text-secondary small">–û–±—ä—ë–º</th>
                            <th class="text-secondary small">–ü—Ä–æ—Ñ–∏—Ç</th>
                        </tr>
                        </thead>
                        <tbody id="trades-body">
                        <tr>
                            <td colspan="5" class="text-center text-secondary small py-4">
                                –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="col-lg-5">
            <div class="card card-theme p-3 h-100">

                <h5 class="mb-3">
                    <i class="bi bi-gear me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                </h5>

                <ul class="list-unstyled small">
                    <li class="mb-2">–°–∏–º–≤–æ–ª: <span class="fw-bold" th:text="${symbol}">BTCUSDT</span></li>
                    <li class="mb-2">–¢–∞–π–º—Ñ—Ä–µ–π–º: <span class="fw-bold" th:text="${info?.timeframe}">‚Äî</span></li>
                    <li class="mb-2">TP: <span class="fw-bold" th:text="${info?.takeProfitPct != null ? info.takeProfitPct + '%' : '‚Äî'}"></span></li>
                    <li class="mb-2">SL: <span class="fw-bold" th:text="${info?.stopLossPct != null ? info.stopLossPct + '%' : '‚Äî'}"></span></li>
                    <li class="mb-2">–ö–æ–º–∏—Å—Å–∏—è: <span class="fw-bold" th:text="${info?.commissionPct != null ? info.commissionPct + '%' : '‚Äî'}"></span></li>
                    <li class="mb-2">–†–∏—Å–∫/—Å–¥–µ–ª–∫–∞: <span class="fw-bold" th:text="${info?.riskPerTradePct != null ? info.riskPerTradePct + '%' : '‚Äî'}"></span></li>
                </ul>

                <a class="btn btn-outline-primary w-100 mt-3"
                   th:href="@{'/strategies/' + ${type} + '/config'(chatId=${chatId})}">
                    <i class="bi bi-pencil-square me-2"></i>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
                </a>

            </div>
        </div>

    </div>

</div>




</body>

</html>
